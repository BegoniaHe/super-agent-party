<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super API Party</title>
  <link rel="stylesheet" href="css/styles.css">
  <!-- 引入Element Plus样式 -->
  <link rel="stylesheet" href="node_modules/element-plus/dist/index.css">
</head>
<body>
  <div id="app">
    <!-- 顶部栏 -->
    <el-header class="top-bar" height="30px">
      <div class="window-controls">
        <el-button @click="minimizeWindow" class="top-bar-btn" text>
          <el-icon><Minus /></el-icon>
        </el-button>
          <el-button @click="maximizeWindow" class="top-bar-btn" text>
          <el-icon><Expand /></el-icon>
        </el-button>
        <el-button @click="closeWindow" class="top-bar-btn" text>
          <el-icon><Close /></el-icon>
        </el-button>
      </div>
    </el-header>

    <!-- 主容器 -->
    <el-container class="main-container">
      <!-- 侧边栏 -->
      <el-aside :width="isCollapse ? '64px' : '200px'" class="sidebar">
        <el-menu
          :collapse="isCollapse"
          :default-active="activeMenu"
          class="el-menu-vertical"
          @select="handleSelect">
          <el-menu-item index="home">
            <el-icon><House /></el-icon>
            <template #title>主页</template>
          </el-menu-item>
          <el-menu-item index="tools">
            <el-icon><Tools /></el-icon>
            <template #title>工具</template>
          </el-menu-item>
          <el-menu-item index="api">
            <el-icon><Connection /></el-icon>
            <template #title>API信息</template>
          </el-menu-item>
          <el-menu-item index="settings">
            <el-icon><Setting /></el-icon>
            <template #title>设置</template>
          </el-menu-item>
        </el-menu>
      </el-aside>

      <!-- 内容区 -->
      <el-main class="content">
        <div v-show="activeMenu === 'home'" class="page chat-container">
          <!-- 聊天消息列表 -->
          <div class="messages-container" ref="messagesContainer">
            <div v-for="(message, index) in messages" :key="index" class="message" :class="message.role">
              <div class="message-content" 
                   v-html="message.role === 'user' ? message.content : formatMessage(message.content)">
              </div>
            </div>
            <div v-if="isTyping" class="message assistant">
              <div class="message-content typing">
                <div class="typing-indicator">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
          
        <!-- 输入框区域 -->
        <div class="input-container">
          <el-input
            v-model="userInput"
            type="textarea"
            :rows="3"
            placeholder="输入消息..."
            resize="none"
            @keydown="handleKeydown"
          />
          <el-button type="primary" @click="sendMessage" :loading="isTyping">发送</el-button>
        </div>
        </div>

        <!-- 工具界面 -->
        <div v-show="activeMenu === 'tools'" class="page tools-container">
          <el-form :model="toolsSettings" class="settings-form">
            <!-- 时间工具 -->
            <div class="tool-item">
              <div class="tool-header" @click="toggleSection('time')">
                <span>当前时间</span>
                <el-switch v-model="toolsSettings.time.enabled" @click.stop/>
              </div>
              <div v-show="expandedSections.time" class="tool-content">
                <el-form-item label="时区设置">
                  <el-select v-model="toolsSettings.time.timezone">
                    <el-option
                      v-for="timezone in timezones"
                      :key="timezone.key"
                      :label="timezone.label"
                      :value="timezone.key"/></el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>

            <!-- 知识库工具 -->
            <div class="tool-item">
              <div class="tool-header" @click="toggleSection('knowledge')">
                <span>知识库管理</span>
                <el-switch v-model="toolsSettings.knowledge.enabled" @click.stop/>
              </div>
              <div v-show="expandedSections.knowledge" class="tool-content">
                <el-form-item label="检索模型">
                  <el-input v-model="toolsSettings.knowledge.model"/>
                </el-form-item>
                <el-form-item label="文件上传">
                  <el-upload :auto-upload="false" :on-change="handleFileUpload">
                    <el-button type="primary">选择文件</el-button>
                  </el-upload>
                </el-form-item>
              </div>
            </div>

            <!-- 联网工具 -->
            <div class="tool-item">
              <div class="tool-header" @click="toggleSection('network')">
                <span>联网搜索</span>
                <el-switch v-model="toolsSettings.network.enabled" @click.stop/>
              </div>
              <div v-show="expandedSections.network" class="tool-content">
                <el-form-item label="搜索引擎">
                  <el-select v-model="toolsSettings.network.search_engine">
                    <el-option label="DuckDuckGo" value="duckduckgo"/></el-option>
                    <el-option label="Google" value="google"/></el-option>
                    <el-option label="Bing" value="bing"/></el-option>
                  </el-select>
                </el-form-item>
              </div>
            </div>
          </el-form>
        </div>

        <!-- API列表 -->
        <div v-show="activeMenu === 'api'" class="page api-container">
          <div class="api-info">
            <h3>API 端点</h3>
            <el-input 
              :value="'http://127.0.0.1:3456/v1'" 
              readonly 
              class="api-endpoint"
            >
              <template #append>
                <el-button 
                  @click="copyEndpoint"
                  :icon="'document-copy'"
                />
              </template>
            </el-input>
            
            <h3>可用模型</h3>
            <div class="model-list">
              <div v-if="modelsLoading" class="loading-models">
                <el-icon class="is-loading"><Loading /></el-icon>
                正在加载模型...
              </div>
              <div v-else-if="modelsError" class="error-models">
                <el-icon><Warning /></el-icon>
                模型加载失败: {{ modelsError }}
              </div>
                <!-- 确保表格列与数据字段匹配 -->
                <el-table :data="models" class="model-table">
                  <!-- index.html -->
                  <el-table-column prop="id" label="模型ID">
                    <template #default="{row}">
                      <span 
                        class="copyable" 
                        @click="copyModelId(row.id || 'model')"
                      >
                        {{ row.id || 'model' }}
                      </span>
                    </template>
                  </el-table-column>
                  <el-table-column prop="created" label="创建时间" width="180">
                    <template #default="{row}">
                      {{ row.created || '未知' }}
                    </template>
                  </el-table-column>
                </el-table>
            </div>
          </div>
        </div>
        

        <!-- 设置列表 -->
        <div v-show="activeMenu === 'settings'" class="page settings-container">
          <el-form :model="settings" class="settings-form">
            <el-form-item label="模型名称" class="form-item-align">
              <el-input 
                v-model="settings.model" 
                placeholder="模型名称"
                @input="autoSaveSettings" 
                class="full-width-input"
              />
            </el-form-item>
            <el-form-item label="基础URL" class="form-item-align">
              <el-input 
                v-model="settings.base_url" 
                placeholder="基础URL"
                @input="autoSaveSettings"
                class="full-width-input"
              />
            </el-form-item>
            <el-form-item label="API密钥" class="form-item-align">
              <el-input 
                v-model="settings.api_key" 
                placeholder="API密钥" 
                show-password
                @input="autoSaveSettings"
                class="full-width-input"
              />
            </el-form-item>
            <el-form-item label="温度" class="form-item-align">
              <el-slider
                v-model="settings.temperature"
                :min="0"
                :max="1"
                :step="0.1"
                @input="autoSaveSettings"
              />
            </el-form-item>
            <el-form-item label="输出长度" class="form-item-align">
              <el-slider
                v-model="settings.max_tokens"
                :min="0"
                :max="128000"
                :step="1024"
                @input="autoSaveSettings"
              />
            </el-form-item>
            <el-form-item label="对话轮数" class="form-item-align">
              <el-slider
                v-model="settings.max_rounds"
                :min="0"
                :max="1000"
                :step="2"
                @input="autoSaveSettings"
              />
            </el-form-item>
          </el-form>
        </div>
      </el-main>
    </el-container>
  </div>

  <!-- 引入Vue和Element Plus -->
  <script src="node_modules/vue/dist/vue.global.js"></script>
  <script src="node_modules/element-plus/dist/index.full.js"></script>
  <script src="node_modules/@element-plus/icons-vue/dist/index.iife.min.js"></script>
  <script src="js/renderer.js"></script>
</body>
</html>
